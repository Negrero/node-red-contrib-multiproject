<!--
  Copyright 2013, 2015 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="project">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-envelope"></i> Name Project</label>
        <input type="text" id="node-config-input-name" placeholder="Name project">
    </div>
</script>

<script type="text/x-red" data-help-name="project">
    <p>Sends the <code>msg.payload</code> as an email, with a subject of <code>msg.topic</code>.</p>
    <p>The default message recipient can be configured in the node, if it is left
    blank it should be set using the <code>msg.to</code> property of the incoming message. If left blank
    you can also specify <code>msg.cc</code> and/or <code>msg.bcc</code> properties.</p>
    <p>The payload can be html format.</p>
    <p>If the payload is a binary buffer then it will be converted to an attachment.
    The filename should be set using <code>msg.filename</code>. Optionally <code>msg.description</code> can be added for the body text.</p>
    <p>Alternatively you may provide <code>msg.attachments</code> which should contain an array of one or
    more attachments in <a href="https://www.npmjs.com/package/nodemailer#attachments" target="_new">nodemailer</a> format.</p>
    <p>If required by your recipient you may also pass in a <code>msg.envelope</code> object, typically containing extra from and to properties.</p>
    <p>Note: uses SMTP with SSL to port 465.</p>
</script>

<script type="text/javascript">
    (function() {
        RED.nodes.registerType('project',{
            inputs:0,
            outputs:0,
            category:'config',
            label: function() {
                return this.label||"project";
            },
            labelStyle: function() {
                return (this.dname||!this.topic)?"node_label_italic":"";
            },
            oneditprepare: function() {
                if (this.credentials.global) {
                    $('#node-tip').show();
                } else {
                    $('#node-tip').hide();
                }
            }
        });
    })();
</script>

<!-- *************************************** UI PROJECTS ***************************** -->
<script type="text/javascript">
    RED.projects = (function () {
        var projects = []
        function init(data) {
            RED.projects.deploy()
            $( '<span id="label-projects" class="logo" style="margin-left:20%;font-size:1em;">Projects:</span>' ).insertAfter(".logo");
            projects = {}
            var options=[]
            var selected=false
            $.each(data, function (key, value) {
                if(selected){
                    options.push({
                                id:value.id,
                                label: value.label,
                                onselect:function(s) {
                                    if(s===undefined || s){
                                        $('#label-projects').html('<p style="font-size: 1.3em">Project: '+value.label+'</p>')
                                        loadFlows(value.id)}}
                            }

                    )
                }else{
                    selected=true
                    options.push({
                        id:value.id,
                        label: value.label,
                        selected: true,
                        onselect:function(s) {
                            if(s===undefined || s){
                                $('#label-projects').html('<p style="font-size: 1.3em">Project: '+value.label+'</p>')
                                loadFlows(value.id)
                            }

                        }}

                    )
                }
            });
            $('<li><span class="projects-button-group button-group">'+
                    '<a id="btn-projects" href="#" class="btn-info"><span>Projects</span></a>'+
                    '<a id="btn-projects-options" data-toggle="dropdown" class="btn-info" href="#"><i class="fa fa-caret-down"></i></a>'+
                    '</span></li>').prependTo(".header-toolbar");
            RED.menu.init({id:"btn-projects-options",options:options})
            /*
             $.each(data, function (key, value) {
             projects[value.id] = value
             $('#selectProjects').append($("<option>", {
             value: value.id,
             text: value.label

             }));
             });
             */
            /*
             $('#selectProjects').change(function () {
             var id = $(this).val()
             cleanWorkspace()
             loadFlows(id)
             })
             */
            //loadFlows($("#selectProjects").val());
        }
        function cleanWorkspace() {
            var workspace = RED.nodes.getWorkspaceOrder()
            $( '#btn-workspace-add-tab' ).trigger( "click" );
            while(workspace.length != 1){
                RED.workspaces.remove(RED.nodes.workspace(workspace[0]))
                RED.tray.close();
                RED.nodes.removeWorkspace(workspace[0])
            }
        }

        function loadFlows(id) {
            $.ajax({
                headers: {
                    "Accept": "application/json"
                },
                cache: false,
                url: 'projects/' + id,
                data: {id: id},
                dataType: 'json',
                success: function (nodes) {
                    cleanWorkspace()
                    var workspace = RED.nodes.getWorkspaceOrder()
                    if(workspace.length>0){
                        RED.nodes.import(nodes);
                        RED.nodes.dirty(false);
                        RED.workspaces.remove(RED.nodes.workspace(workspace[0]))
                        RED.nodes.removeWorkspace(workspace[0])

                    }else{
                        RED.nodes.import(nodes);
                        RED.nodes.dirty(false);
                    }
                    RED.view.redraw(true);
                    RED.workspaces.refresh();
                    RED.sidebar.config.refresh();
                    RED.comms.subscribe("status/#", function (topic, msg) {
                        var parts = topic.split("/");
                        var node = RED.nodes.node(parts[1]);
                        if (node) {
                            if (msg.hasOwnProperty("text")) {
                                msg.text = node._(msg.text.toString(), {defaultValue: msg.text.toString()});
                            }
                            node.status = msg;
//if (statusEnabled) {
//    node.dirty = true;
                            RED.view.redraw();
//}
                        }
                    });
                    RED.comms.subscribe("node/#", function (topic, msg) {
                        var i, m;
                        var typeList;
                        var info;

                        if (topic == "node/added") {
                            var addedTypes = [];
                            for (i = 0; i < msg.length; i++) {
                                m = msg[i];
                                var id = m.id;
                                RED.nodes.addNodeSet(m);
                                addedTypes = addedTypes.concat(m.types);
                                RED.i18n.loadCatalog(id, function () {
                                    $.get('nodes/' + id, function (data) {
                                        $("body").append(data);
                                    });
                                });
                            }
                            if (addedTypes.length) {
                                typeList = "<ul><li>" + addedTypes.join("</li><li>") + "</li></ul>";
                                RED.notify(RED._("palette.event.nodeAdded", {count: addedTypes.length}) + typeList, "success");
                            }
                        } else if (topic == "node/removed") {
                            for (i = 0; i < msg.length; i++) {
                                m = msg[i];
                                info = RED.nodes.removeNodeSet(m.id);
                                if (info.added) {
                                    typeList = "<ul><li>" + m.types.join("</li><li>") + "</li></ul>";
                                    RED.notify(RED._("palette.event.nodeRemoved", {count: m.types.length}) + typeList, "success");
                                }
                            }
                        } else if (topic == "node/enabled") {
                            if (msg.types) {
                                info = RED.nodes.getNodeSet(msg.id);
                                if (info.added) {
                                    RED.nodes.enableNodeSet(msg.id);
                                    typeList = "<ul><li>" + msg.types.join("</li><li>") + "</li></ul>";
                                    RED.notify(RED._("palette.event.nodeEnabled", {count: msg.types.length}) + typeList, "success");
                                } else {
                                    $.get('nodes/' + msg.id, function (data) {
                                        $("body").append(data);
                                        typeList = "<ul><li>" + msg.types.join("</li><li>") + "</li></ul>";
                                        RED.notify(RED._("palette.event.nodeAdded", {count: msg.types.length}) + typeList, "success");
                                    });
                                }
                            }
                        } else if (topic == "node/disabled") {
                            if (msg.types) {
                                RED.nodes.disableNodeSet(msg.id);
                                typeList = "<ul><li>" + msg.types.join("</li><li>") + "</li></ul>";
                                RED.notify(RED._("palette.event.nodeDisabled", {count: msg.types.length}) + typeList, "success");
                            }
                        }
// Refresh flow library to ensure any examples are updated
                        RED.library.loadFlowLibrary();
                    });
                }
            });
        }

        return {
            init: init,
            getProjects: projects,
            loadFlows:loadFlows,
            cleanWorkspace:cleanWorkspace

        }

    })();
    (function() {
        $.ajax({
            headers: {
                "Accept":"application/json"
            },
            cache: false,
            url: 'projects',
            success: function(data) {
                RED.projects.init(data);
            }

        });
    })()

</script>
<!-- *************************************** DEPLOY ********************************** -->
<script type="text/javascript">
    RED.projects.deploy=function() {
        var ignoreDeployWarnings = {
            unknown: false,
            unusedConfig: false,
            invalid: false
        }
        function sortNodeInfo(A,B) {
            if (A.tab < B.tab) { return -1;}
            if (A.tab > B.tab) { return 1;}
            if (A.type < B.type) { return -1;}
            if (A.type > B.type) { return 1;}
            if (A.name < B.name) { return -1;}
            if (A.name > B.name) { return 1;}
            return 0;
        }
        function getNodeInfo(node) {
            var tabLabel = "";
            if (node.z) {
                var tab = RED.nodes.workspace(node.z);
                if (!tab) {
                    tab = RED.nodes.subflow(node.z);
                    tabLabel = tab.name;
                } else {
                    tabLabel = tab.label;
                }
            }
            var label = "";
            if (typeof node._def.label == "function") {
                label = node._def.label.call(node);
            } else {
                label = node._def.label;
            }
            label = label || node.id;
            return {tab:tabLabel,type:node.type,label:label};
        }
        $('#btn-deploy').unbind("click");
        $('#btn-deploy').click(function () {
            save();
        });

        function save(force) {
            if (RED.nodes.dirty()) {
                //$("#debug-tab-clear").click();  // uncomment this to auto clear debug on deploy

                if (!force) {
                    var hasUnknown = false;
                    var hasInvalid = false;
                    var hasUnusedConfig = false;

                    var unknownNodes = [];
                    var invalidNodes = [];

                    RED.nodes.eachNode(function (node) {
                        hasInvalid = hasInvalid || !node.valid;
                        if (!node.valid) {
                            invalidNodes.push(getNodeInfo(node));
                        }
                        if (node.type === "unknown") {
                            if (unknownNodes.indexOf(node.name) == -1) {
                                unknownNodes.push(node.name);
                            }
                        }
                    });
                    hasUnknown = unknownNodes.length > 0;

                    var unusedConfigNodes = [];
                    RED.nodes.eachConfig(function (node) {
                        if (node.users.length === 0 && (node._def.hasUsers !== false)) {
                            unusedConfigNodes.push(getNodeInfo(node));
                            hasUnusedConfig = true;
                        }
                    });

                    $("#node-dialog-confirm-deploy-config").hide();
                    $("#node-dialog-confirm-deploy-unknown").hide();
                    $("#node-dialog-confirm-deploy-unused").hide();

                    var showWarning = false;

                    if (hasUnknown && !ignoreDeployWarnings.unknown) {
                        showWarning = true;
                        $("#node-dialog-confirm-deploy-type").val("unknown");
                        $("#node-dialog-confirm-deploy-unknown").show();
                        $("#node-dialog-confirm-deploy-unknown-list")
                                .html("<li>" + unknownNodes.join("</li><li>") + "</li>");
                    } else if (hasInvalid && !ignoreDeployWarnings.invalid) {
                        showWarning = true;
                        $("#node-dialog-confirm-deploy-type").val("invalid");
                        $("#node-dialog-confirm-deploy-config").show();
                        invalidNodes.sort(sortNodeInfo);
                        $("#node-dialog-confirm-deploy-invalid-list")
                                .html("<li>" + invalidNodes.map(function (A) {
                                            return (A.tab ? "[" + A.tab + "] " : "") + A.label + " (" + A.type + ")"
                                        }).join("</li><li>") + "</li>");

                    } else if (hasUnusedConfig && !ignoreDeployWarnings.unusedConfig) {
                        // showWarning = true;
                        // $( "#node-dialog-confirm-deploy-type" ).val("unusedConfig");
                        // $( "#node-dialog-confirm-deploy-unused" ).show();
                        //
                        // unusedConfigNodes.sort(sortNodeInfo);
                        // $( "#node-dialog-confirm-deploy-unused-list" )
                        //     .html("<li>"+unusedConfigNodes.map(function(A) { return (A.tab?"["+A.tab+"] ":"")+A.label+" ("+A.type+")"}).join("</li><li>")+"</li>");
                    }
                    if (showWarning) {
                        $("#node-dialog-confirm-deploy-hide").prop("checked", false);
                        $("#node-dialog-confirm-deploy").dialog("open");
                        return;
                    }
                }


                var nns = RED.nodes.createCompleteNodeSet();
                var projects = {
                    "id": $("#selectProjects").val(),
                    "label": $("#selectProjects option:selected").text(),
                    "type":"project",
                    "flows": []
                }
                console.log(projects.id)
                console.log(projects.label)

                nns.forEach(function (e, i, a) {
                    projects.flows.push(e.id)
                })
                nns.push(projects)
                $("#btn-deploy-icon").removeClass('fa-download');
                $("#btn-deploy-icon").addClass('spinner');
                RED.nodes.dirty(false);
                var deploymentTypes = {
                    "red/images/deploy-full-o.png":"full",
                    "red/images/deploy-nodes-o.png":"nodes",
                    "red/images/deploy-flows-o.png":"flows"
                }
                var deploymentType=deploymentTypes[ $("#btn-deploy img").attr("src")]
                $.ajax({
                    url: "projects",
                    type: "POST",
                    data: JSON.stringify(nns),
                    contentType: "application/json; charset=utf-8",
                    headers: {
                        "Node-RED-Deployment-Type": deploymentType
                    }
                }).done(function (data, textStatus, xhr) {
                    if (hasUnusedConfig) {
                        RED.notify(
                                '<p>' + RED._("deploy.successfulDeploy") + '</p>' +
                                '<p>' + RED._("deploy.unusedConfigNodes") + ' <a href="#" onclick="RED.sidebar.config.show(true); return false;">' + RED._("deploy.unusedConfigNodesLink") + '</a></p>', "success", false, 6000);
                    } else {
                        RED.notify(RED._("deploy.successfulDeploy"), "success");
                    }
                    RED.nodes.eachNode(function (node) {
                        if (node.changed) {
                            node.dirty = true;
                            node.changed = false;
                        }
                        if (node.credentials) {
                            delete node.credentials;
                        }
                    });
                    RED.nodes.eachConfig(function (confNode) {
                        if (confNode.credentials) {
                            delete confNode.credentials;
                        }
                    });
                    // Once deployed, cannot undo back to a clean state
                    RED.history.markAllDirty();
                    RED.view.redraw();
                    RED.events.emit("deploy");
                }).fail(function (xhr, textStatus, err) {
                    RED.nodes.dirty(true);
                    if (xhr.status === 401) {
                        RED.notify(RED._("deploy.deployFailed", {message: RED._("user.notAuthorized")}), "error");
                    } else if (xhr.responseText) {
                        RED.notify(RED._("deploy.deployFailed", {message: xhr.responseText}), "error");
                    } else {
                        RED.notify(RED._("deploy.deployFailed", {message: RED._("deploy.errors.noResponse")}), "error");
                    }
                }).always(function () {
                    $("#btn-deploy-icon").removeClass('spinner');
                    $("#btn-deploy-icon").addClass('fa-download');
                });
            }
        }
    }
</script>